@page "/activity-logs"

@using MudBlazor
@using BikeSparesInventorySystem.Data.Models;
@inject BikeSparesInventorySystem.Data.Repositories.Repository<ActivityLog> ActivityLogRepository;
@inject BikeSparesInventorySystem.Data.Repositories.Repository<Spare> SpareRepository;
@inject BikeSparesInventorySystem.Data.Repositories.Repository<User> UserRepository;
@inject BikeSparesInventorySystem.Data.Services.AuthService AuthService;
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<MudTable Elevation="0" Items="@Elements" FixedHeader="@fixed_header" FixedFooter="@fixed_footer" Height="@(fixed_header || fixed_footer ? "75vh" : "")" Dense="@dense" Hover="@hover" ReadOnly="@ronly" CanCancelEdit="@canCancelEdit" Filter="new Func<ActivityLog,bool>(FilterFunc)"
         SortLabel="Sort By" HorizontalScrollbar="true" >
    <ToolBarContent>
        <MudStack Row="true">
            <MudButton Variant="Variant.Outlined" Color="Color.Primary" StartIcon="@Icons.Filled.Upload">Import</MudButton>
            <MudMenu StartIcon="@Icons.Filled.Download" EndIcon="@Icons.Filled.KeyboardArrowDown" Label="Export" Color="Color.Primary" Variant="Variant.Outlined" FullWidth="true">
                <MudMenuItem>.csv</MudMenuItem>
                <MudMenuItem>.json</MudMenuItem>
                <MudMenuItem>.xlsx</MudMenuItem>
            </MudMenu>            
        </MudStack>
        <MudSpacer />
        <MudStack Row="true">
            <MudTextField @bind-Value="searchString" Label="Search" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" Class="mt-0" Clearable="true"></MudTextField>
            <MudTextField T="string" Class="mt-0" Label="Filter by Month" InputType="InputType.Month" Clearable="true" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.FilterAlt" ValueChanged="(a) => onchanged(a)" />
        </MudStack>
    </ToolBarContent>
    <HeaderContent>
        <MudTh><MudTableSortLabel SortBy="new Func<ActivityLog, object>(x=>x.Id)">ID</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortBy="new Func<ActivityLog, object>(x=>x.SpareID)">Spare</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortBy="new Func<ActivityLog, object>(x=>x.Quantity)">Quantity</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortBy="new Func<ActivityLog, object>(x=>x.Action)">Action</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortBy="new Func<ActivityLog, object>(x=>x.ActedBy)">Acted By</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortBy="new Func<ActivityLog, object>(x=>x.ApprovalStatus)">Approval Status</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortBy="new Func<ActivityLog, object>(x=>x.Approver)">Approver</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortBy="new Func<ActivityLog, object>(x=>x.TakenOut)">Taken Out</MudTableSortLabel></MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd DataLabel="ID"><MudChip>@context.Id</MudChip></MudTd>
        <MudTd DataLabel="Spare">
            <MudStack Row="true" Spacing="0">
            <MudChip>@context.SpareID</MudChip>
            <MudChip>@GetSpareName(context.SpareID)</MudChip>
            </MudStack>
        </MudTd>
        <MudTd DataLabel="Quantity">@context.Quantity</MudTd>
        <MudTd DataLabel="Action">@context.Action</MudTd>
        <MudTd DataLabel="Acted By"><AdminChip user="GetUser(context.ActedBy)"/></MudTd>
        <MudTd DataLabel="Is Approved">@context.ApprovalStatus</MudTd>
        <MudTd DataLabel="Approved By">@if (context.Approver.Equals(Guid.Empty))
            {
                <MudFab Color="Color.Primary" DisableElevation="true" StartIcon="@Icons.Filled.Approval" IconSize="Size.Small" OnClick="() => Approve(context.Id)" Label="Approve" Size="Size.Small"/>
            } else
            {
                @GetUser(context.Approver).Item2          
            }
        </MudTd>
        <MudTd DataLabel="Taken Out">@context.TakenOut</MudTd>        
    </RowTemplate>    
    <PagerContent>
        <MudTablePager />
    </PagerContent>
</MudTable>